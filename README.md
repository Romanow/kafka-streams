# Kafka Streams

Kafka Streams — это Java-библиотека для анализа и обработки данных, хранящихся в Apache Kafka. Как и в любой другой
платформе потоковой обработки, она способна выполнять обработку данных с сохранением и/или без сохранения состояния в
режиме реального времени.

Стрим в Kafka — это полная история всех случившихся событий в мире с начала времён по сегодняшний день. Он представляет
прошлое и настоящее. По мере того, как мы переходим из сегодняшнего дня в завтрашний, новые события постоянно
добавляются к мировой истории.

Таблица в Kafka — это состояние мира на сегодняшний день. Она представляет настощее. Это совокупность (aggregation) всех
событий в мире, которая постоянно изменяется по мере того, как мы переходим из сегодняшнего в завтрашний.

![Topic to Stream to Table](images/topic_to_stream_to_table.png)

### Topic

Топик в Kafka состоит из сообщений ключ-значение. Топик не зависит от формата сериализации или типа сообщений: ключи и
значения в сообщениях трактуются как обычные массивы байтов `byte[]`.

![Plain Stream](images/plain_stream.gif)

![Counter Stream](images/counter_stream.gif)

### Stream

Теперь мы читаем топик в стрим, добавляя информацию о схеме (schema-on-read). Другими словами, counter превращаем сырой,
нетипизированный топик в типизированный топик или стрим.

```
CREATE STREAM github (
  id VARCHAR, 
  type VARCHAR, 
  repo STRUCT<
  	id INT, 
  	name VARCHAR, 
  	url VARCHAR
  >)
WITH (
  KAFKA_TOPIC='github-change-events', 
  VALUE_FORMAT='json'
);
```

### Table

Таблицы — это агрегированные стримы. Всякий раз, когда вы выполняете агрегацию в Kafka Streams или KSQL, результатом
всегда является таблица. Особенность этапа агрегирования определяет, является ли таблица напрямую получаемой из стрима
через семантику UPSERT без состояния (таблица отображает ключи в их последнее значение в стриме, который является
агрегацией при чтении топика Kafka напрямую в таблицу), через подсчёт количества увиденных значений для каждого ключа с
сохранением состояния, или более сложные агрегации, такие как суммирование, усреднение и так далее.

# Литература

1. [KSQL Syntax Reference](https://docs.confluent.io/5.4.1/ksql/docs/developer-guide/syntax-reference.html)
2. [Introducing Kafka Streams: Stream Processing Made Simple](https://www.confluent.io/blog/introducing-kafka-streams-stream-processing-made-simple/)
3. [Обеспечение высокой доступности приложений с Kafka Streams](https://habr.com/ru/post/488558/)
4. [Почему стриминг на KSQL и Kafka Streams — это непросто](https://habr.com/ru/company/glowbyte/blog/492944/)